<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Homepage</title>

    <!-- Bootstrap core CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin-top: 50px;
        }
        section {
            clear: left;
        }
        .itemSerie {
            float: left;
            margin: 10px;
            width: 300px;
            height: 100px;
        }

        .itemVideo {
            float: left;
            margin: 10px;
            width: 300px;
            height: 300px;
        }

    </style>

    <!-- Custom styles for this template -->
    <!-- <link href="starter&#45;template.css" rel="stylesheet"> -->
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Homepage</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Videos</a></li>
            <li><a href="#series">Series</a></li>
            <li><a href="#manga">Manga</a></li>
            <li><a href="#contact">Anime</a></li>
            <li><a href="#contact">Weather</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <section id="videos"><h1 style="text-align:center;">Videos</h1></section>
    <section id="series"><h1 style="text-align:center;">Series</h1></section>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script>
        document.body.onload = function () {

        callAjax("/video/", loadVideos);
        callAjax("/serie/", loadSeries);
};

function loadVideos(data)
{
    var json = JSON.parse(data);
    str = json.filter(function(channel) { return channel._videos.length} )
              .map(function(channel) { return generateVideoView(channel._name, channel._videos[0]); })
              .join("");

   $("#videos").append(str);
}

function loadSeries(data)
{
    var json = JSON.parse(data);

    json.filter(function(serie) { return serie._episodes.length} )
        .forEach(function(serie) {
            serie._episodes.forEach(function(episode) {
                var html = generateSerieView (serie._serieName, episode);
                $("#series").append(html);

            });
    });



}


function generateSerieView(serieName, episode)
{
        var header = '';
        header += '<div class="header dropdown" style="height:30%">';
        header += '<a id="dLabel" type="button" style="width: 90%;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" >';
        header += '<h3>' + serieName.capitalize() + '<span class="caret"></span></h3></a>';
        header += '<ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">';
        header += '</ul>';
        header += "</div>";
        header = $(header);


        header.click(function() { 
            var menu = header.find("ul");
            if(menu.children().length) return;

            callAjax("/serie/" + serieName, function(data) { 
                menu.append(fillEpisodesDropdown(data)); 
            });
        });

        var footer = '';
        footer += '<div class="footer" style="height:70%;">';
        footer += '<a href="' + episode._magnetURI + '">';
        footer += '<p style="margin:0px;">' + episode._name + '</p>';
        footer += '<p style="margin:0px;">' + episode._date + '</p>';
        footer += '</a>';
        footer += '</div>';
        footer = $(footer);

    var str = '';
    str += '<div class="itemSerie">';
    str += '</div>';
    return $(str).append(header).append(footer);

}

function fillEpisodesDropdown(data)
{
    var json = JSON.parse(data);

    var episodes =  json.map(function(serie) {
               return serie._episodes.map(function(episode) {
                   return '<li><a role="menuitem" href="' + episode._magnetURI + '"><b>' + episode._name + '</b> ' + episode._date + '</a></li>';
              });

    });


    return [].concat.apply([], episodes);

}


function generateVideoView(channelName, video)
{
    var str = '';
    str += '<div class="itemVideo">';
        str += '<div class="header" style="height: 10%;">';
        str += '<a href="' + "https://www.youtube.com/user/" + channelName + "/videos" + '"><h3 style="margin:0px;">' + channelName.capitalize() + '</h3></a>';
        str += "</div>";

        str += '<div class="thumbnail" style="height:60%;"  >';
        str += '<a href="' + video._url + '">';
        str += '<img src="' + video._thumbnail + '" style="height: 100%;width:100%;" /></a>';
        str += '</div>';


        str += '<div class="footer" style="height:30%;">';
        str += '<a href="' + video._url + '">';
        str += '<p style="margin:0px;">' + video._titre + '</p>';
        str += '</a>';
        str += '</div>';
    str += '</div>';

    return str;
}


String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
}

function callAjax(url, callback)
{
    var xmlhttp;
    // compatible with IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function(){
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
            callback(xmlhttp.responseText);
        }
    }
    xmlhttp.open("GET", url, true);
    xmlhttp.send();
}
    </script>
  </body>
</html>
